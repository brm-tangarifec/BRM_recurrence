<?php

/**
 *M贸dulo para la recurrencia
 * Implement hook_menu()
 */

function BRM_recurrence_menu() {
  return array(
  	'cart/recurrence' => array(
  	'page callback' => 'recurrenceTpl',
  	'access arguments' => TRUE,
  	'access callback' => TRUE,
  	'type' => MENU_CALLBACK,


    ),
  );
}

//Funci贸n para alterar el comportamiento de una url

function BRM_recurrence_url_inbound_alter(&$path, $original_path, $path_language) {

  // Se agrega js al carrito
  if (preg_match('|^cart(/.*)?|', $path, $matches)) {
  		drupal_add_js(drupal_get_path('module', 'BRM_recurrence') . '/js/recurrence.js', array( 'scope' => 'footer', 'weight' => 7 , 'group' => JS_LIBRARY, 'preprocess' => FALSE, 'cache' => FALSE));
  }

  if ($path=='cart/checkout') {
  	if(isset($_COOKIE['carritoR']) && !empty($_COOKIE['carritoR'])){
  		drupal_goto('cart/recurrence');
  	}
  }
}

//Funci贸n para cargar los temas

function BRM_recurrence_theme($existing, $type, $theme, $path){
    return array(
      'recurrence' => array(
        'template' => 'theme/recurrence'
      ),
  );
}


/*Obtener el tpl para activar la recurrencia*/
function recurrenceTpl(){
	global $user;
	printVar($user->uid);
	printVar(base64_decode($_COOKIE['carritoR']));
	$carritoR=json_decode(base64_decode($_COOKIE['carritoR']));
	printVar($carritoR);
	if (!isset($order)) {
      // Create a new order if necessary.
      $order = uc_order_new($user->uid,'in_checkout');
      $_SESSION['cart_order'] = $order->order_id;
      $rebuild = TRUE;
    }
	foreach ($carritoR as $key => $value) {
		printVar($value);
		$productK=orderByIdKit($value->kitId);
		printVar($productK);
	}
	$variables['carrito']= uc_cart_get_contents();
	return theme('recurrence',$variables);
}


function orderByIdKit($idKit){
	$dataK=array();
	$query=db_select('uc_product_kits','upk');
	$result=$query->fields('upk',array('product_id'))
	->condition('upk.nid',$idKit,'=')
	->execute();
	while($record=$result->fetchAssoc()){
		$dataK[]=$record['product_id'];
	}
	return $dataK;
}


function saveDataRecurrence($idKit,$kit,$recurrence){
$return = $upd= db_insert('brm_recurrence')
->fields(array(
	'order_id' =>1 ,
	'product_id' => 1,
	'id_brm_recurrence_token' => 1,
	'recurrence_days' =>1,
	'active' =>'y',
	'created' => REQUEST_TIME,
))->execute();
}

/*
**Creaci贸n de ordenes

    // Prepare the cart order.
    $rebuild = FALSE;
    if (!isset($order)) {
      // Create a new order if necessary.
      $order = uc_order_new($user->uid);
      $_SESSION['cart_order'] = $order->order_id;
      $rebuild = TRUE;
    }
    elseif (!empty($_SESSION['uc_cart_order_rebuild'])) {
      // Or, if the cart has changed, then remove old products and line items.
      $efq = new EntityFieldQuery();
      $result = $efq->entityCondition('entity_type', 'uc_order_product')
        ->propertyCondition('order_id', $order->order_id)
        ->execute();
      if (!empty($result['uc_order_product'])) {
        $product_ids = array_keys($result['uc_order_product']);
        uc_order_product_delete_multiple($product_ids);
      }
      uc_order_delete_line_item($order->order_id, TRUE);
      $rebuild = TRUE;
    }

    if ($rebuild) {
      // Copy the cart contents to the cart order.
      $order->products = uc_cart_get_contents();
      unset($_SESSION['uc_cart_order_rebuild']);
    }
    elseif (!uc_order_product_revive($order->products)) {
      drupal_set_message(t('Some of the products in this order are no longer available.'), 'error');
      drupal_goto('cart');
    } 

*/